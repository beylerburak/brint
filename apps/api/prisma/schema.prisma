// Prisma Schema File
// This file defines the database schema using Prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum WorkspacePlan {
  FREE
  STARTER
  PRO
  AGENCY
}

enum TimezonePreference {
  WORKSPACE // Use workspace timezone
  LOCAL // Use user's own timezone
}

enum DateFormat {
  DMY // 31.12.2025
  MDY // 12/31/2025
  YMD // 2025-12-31
}

enum TimeFormat {
  H24 // 23:45
  H12 // 11:45 PM
}

enum WorkspaceRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum MediaKind {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT // pdf, docx, ppt, etc.
  FONT // otf, ttf, woff, woff2
  ARCHIVE // zip, rar, 7z
  OTHER
}

enum MediaStatus {
  PENDING // record created, upload in progress or not started
  PROCESSING // original uploaded, variants being generated
  READY // everything done, safe to use in UI/publish
  FAILED // processing failed
}

enum BrandStatus {
  ACTIVE
  ARCHIVED
}

enum BrandContactType {
  PHONE
  WHATSAPP
  EMAIL
  ADDRESS
  WEBSITE
}

enum ActivityEntityType {
  WORKSPACE
  BRAND
  SOCIAL_ACCOUNT
  CONTENT
  PUBLICATION
  MEDIA
  USER
  SETTINGS
  PROJECT
  TASK
  COMMENT
  OTHER
}

enum ActivityActorType {
  USER // paneldeki kullanıcı
  SYSTEM // uygulamanın kendi otomatik işleri
  WORKER // queue worker'ları
  INTEGRATION // dış servisler: Meta API, Google Ads vb.
}

enum ActivityVisibility {
  INTERNAL // sadece internal ekranlarda
  CLIENT // müşteri de görebilir
  SYSTEM // sadece debug/log amaçlı, UI'da gösterilmeyebilir
}

enum ActivitySeverity {
  INFO
  WARNING
  ERROR
}

enum ProjectStatus {
  PLANNED
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatusGroup {
  TODO
  IN_PROGRESS
  DONE
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String?   @unique
  password      String? // bcrypt hash - optional for OAuth users
  name          String?
  emailVerified DateTime?
  avatarUrl     String?
  avatarMediaId String? // Reference to Media for avatar
  googleId      String?   @unique

  // Timezone and formatting preferences
  timezonePreference TimezonePreference @default(WORKSPACE)
  timezone           String? // User's own timezone (IANA), used when timezonePreference = LOCAL
  locale             String? // e.g. "tr-TR"
  dateFormat         DateFormat         @default(DMY)
  timeFormat         TimeFormat         @default(H24)

  // Contact / phone
  phoneNumber     String?
  phoneVerifiedAt DateTime?

  // Onboarding lifecycle
  onboardingCompletedAt DateTime? // null => onboarding incomplete

  // Generic user settings (e.g. notifications, theme)
  settings Json?

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  workspaceMembers WorkspaceMember[]
  ownedWorkspaces  Workspace[]
  sessions         Session[]
  media            Media[]
  avatarMedia      Media?            @relation("UserAvatar", fields: [avatarMediaId], references: [id])
  
  // Project & Task relations
  createdProjects       Project[]           @relation("ProjectCreatedBy")
  updatedProjects       Project[]           @relation("ProjectUpdatedBy")
  assignedTasks         Task[]              @relation("TaskAssignee")
  createdTasks          Task[]              @relation("TaskCreatedBy")
  updatedTasks          Task[]              @relation("TaskUpdatedBy")
  createdChecklistItems TaskChecklistItem[] @relation("ChecklistItemCreatedBy")
  completedChecklistItems TaskChecklistItem[] @relation("ChecklistItemCompletedBy")
  createdTaskAttachments TaskAttachment[]   @relation("TaskAttachmentCreatedBy")
  
  // Comment relations
  authoredComments Comment[] @relation("CommentAuthor")

  // Email verification
  emailVerificationCodes EmailVerificationCode[]

  @@map("users")
}

model Workspace {
  id   String @id @default(cuid())
  name String
  slug String @unique

  // Owner relation
  ownerUserId String
  owner       User   @relation(fields: [ownerUserId], references: [id])

  // Visual / branding
  avatarUrl String?

  // Config / localization
  timezone     String @default("Europe/Istanbul")
  locale       String @default("tr-TR")
  baseCurrency String @default("TRY")

  // Subscription-lite / plan
  plan WorkspacePlan @default(FREE)

  // Generic settings for per-workspace configuration
  settings Json?

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  members      WorkspaceMember[]
  brands       Brand[]
  media        Media[]
  activityLogs ActivityLog[]
  
  // Project & Task relations
  projects     Project[]
  taskStatuses TaskStatus[]
  tasks        Task[]
  comments     Comment[]

  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(EDITOR)
  createdAt   DateTime      @default(now())
  user        User          @relation(fields: [userId], references: [id])
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
  @@map("workspace_members")
}

model Session {
  id           String   @id // refresh token payload'daki `tid` ile birebir
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  userAgent    String?
  ipAddress    String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([userId, expiresAt])
  @@map("sessions")
}

model Brand {
  id          String @id @default(cuid())
  workspaceId String

  name String
  slug String @unique

  description String?
  industry    String?
  country     String?
  city        String?

  primaryLocale String?
  timezone      String?

  status BrandStatus @default(ACTIVE)

  logoMediaId String?

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  logoMedia    Media?        @relation("BrandLogo", fields: [logoMediaId], references: [id], onDelete: SetNull)
  media        Media[]
  activityLogs ActivityLog[]

  /// Yeni relations
  contactChannels BrandContactChannel[]
  profile         BrandProfile?
  
  // Project & Task relations
  projects     Project[]
  taskStatuses TaskStatus[]
  tasks        Task[]
  comments     Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@map("brands")
}

model BrandContactChannel {
  id      String @id @default(cuid())
  brandId String

  /// İletişim tipi:
  /// PHONE, WHATSAPP, EMAIL, ADDRESS, WEBSITE
  type BrandContactType

  /// Kullanıcıya gösterilecek label:
  /// "Yönetim", "Genel", "Kurumsal" vb.
  label String?

  /// Asıl değer:
  /// PHONE/WHATSAPP -> "+90 5xx..."
  /// EMAIL          -> "info@..."
  /// ADDRESS        -> ".... Mah., ... Sok., .../İstanbul"
  /// WEBSITE        -> "https://..."
  value String

  /// UI'da öne çıkarılacak kanal mı?
  isPrimary Boolean @default(false)

  /// Sıralama için
  order Int @default(0)

  /// Tipine göre ekstra metadata:
  /// ADDRESS -> { "city": "İstanbul", "country": "TR", "googleMapsUrl": "..." }
  /// PHONE   -> { "countryCode": "+90" }
  /// WEBSITE -> { "kind": "corporate" | "landing" }
  metaJson Json?

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId, type])
  @@map("brand_contact_channels")
}

model BrandProfile {
  id      String @id @default(cuid())
  brandId String @unique

  /// Şema versiyonu (ileride data yapısını değiştirirsen işe yarar)
  version String @default("v1")

  /// Brand Profile'ın asıl JSON verisi
  data Json

  /// Overview'deki skor için:
  optimizationScore          Int?
  optimizationScoreUpdatedAt DateTime?

  /// AI için kısa ve detaylı özetler
  aiSummaryShort    String?
  aiSummaryDetailed String?

  lastEditedByUserId String?
  lastEditedAt       DateTime  @default(now())
  lastAiRefreshAt    DateTime?

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("brand_profiles")
}

model Media {
  id          String  @id @default(cuid())
  workspaceId String
  brandId     String?
  ownerUserId String

  kind   MediaKind
  status MediaStatus @default(PENDING)

  originalFilename String
  extension        String
  mimeType         String
  sizeBytes        Int

  // IMAGE-specific
  width  Int?
  height Int?

  // VIDEO-specific
  durationMs Int?

  storageProvider String @default("S3")
  bucket          String
  baseKey         String // e.g. "media/{workspaceId}/{mediaId}/original.jpg"

  variants Json? // variant metadata (flexible schema)

  isPublic Boolean @default(false)

  title       String?
  alt         String?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  brand       Brand?    @relation(fields: [brandId], references: [id])
  owner       User      @relation(fields: [ownerUserId], references: [id])
  userAvatars User[]    @relation("UserAvatar")
  brandLogos  Brand[]   @relation("BrandLogo")
  
  // Task relations
  taskAttachments TaskAttachment[]

  @@index([workspaceId])
  @@index([brandId])
  @@map("media")
}

/// ActivityLog - Global event/activity log for the entire application.
/// 
/// This single table captures all important events across domains:
/// - Brand operations: "brand.created", "brand.updated"
/// - Content operations: "content.scheduled", "content.published"
/// - Publication events: "publication.failed", "publication.completed"
/// - Worker events: automated tasks and background jobs
/// 
/// Benefits:
/// - Single source of truth for all activities
/// - Easy timeline reconstruction via entityType + entityId
/// - Flexible actor types (USER, SYSTEM, WORKER, INTEGRATION)
/// - Visibility control (INTERNAL, CLIENT, SYSTEM)
/// - Rich payload for debugging and audit trails
model ActivityLog {
  id          String  @id @default(cuid())
  workspaceId String
  brandId     String? // brand'e bağlı olmayan workspace-level eventler için null olabilir

  entityType ActivityEntityType
  entityId   String // Brand.id, Content.id, Publication.id vs.

  /// Domain seviyesinde event kodu:
  /// Örn: "brand.created", "brand.profile_updated",
  /// "content.scheduled", "publication.failed"
  eventKey String

  /// UI'da kısa açıklama olarak gösterilebilecek mesaj
  message String?

  /// Ek kategori / context:
  /// Örn: "brand_profile", "scheduler", "publication_worker"
  context String?

  actorType   ActivityActorType
  actorUserId String? // USER ise dolu, diğer actor tiplerinde genelde null
  actorLabel  String? // "Scheduler Worker", "Meta API" gibi serbest text

  /// Detaylı event payload'u:
  /// örn: before/after diff, error bilgileri, sayısal değerler
  payload Json?

  visibility ActivityVisibility @default(INTERNAL)
  severity   ActivitySeverity   @default(INFO)

  createdAt DateTime @default(now())

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id])
  brand     Brand?    @relation(fields: [brandId], references: [id])

  @@index([workspaceId, createdAt])
  @@index([brandId, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([eventKey, createdAt])
  @@map("activity_logs")
}

/// ============================================================================
/// PROJECT & TASK MANAGEMENT MODELS
/// ============================================================================

model Project {
  id          String  @id @default(cuid())
  workspaceId String
  brandId     String?

  name        String
  description String?
  status      ProjectStatus @default(PLANNED)

  startDate DateTime?
  endDate   DateTime?

  createdByUserId String
  updatedByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand           Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  createdByUser   User      @relation("ProjectCreatedBy", fields: [createdByUserId], references: [id])
  updatedByUser   User?     @relation("ProjectUpdatedBy", fields: [updatedByUserId], references: [id])
  tasks           Task[]

  @@index([workspaceId, brandId])
  @@index([status])
  @@index([createdByUserId])
  @@map("projects")
}

model TaskStatus {
  id          String  @id @default(cuid())
  workspaceId String
  brandId     String? // null = workspace-level status

  group      TaskStatusGroup
  key        String // NOT_STARTED, IN_PROGRESS, COMPLETED, etc.
  label      String // User-facing label
  color      String? // Hex color or token
  isDefault  Boolean @default(false)
  isSystem   Boolean @default(false) // System-created, cannot be deleted
  isActive   Boolean @default(true)
  sortOrder  Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand     Brand?    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([workspaceId, brandId, group])
  @@index([workspaceId, group, isDefault])
  @@map("task_statuses")
}

model Task {
  id          String  @id @default(cuid())
  workspaceId String
  brandId     String?
  projectId   String?
  statusId    String

  taskNumber  Int     // Sequential number per workspace, starting from 1
  title       String
  description String?
  priority    TaskPriority @default(MEDIUM)

  assigneeUserId String?
  dueDate        DateTime?

  createdByUserId String
  updatedByUserId String?

  deletedAt DateTime? // Soft delete

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workspace       Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand           Brand?              @relation(fields: [brandId], references: [id], onDelete: SetNull)
  project         Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)
  status          TaskStatus          @relation(fields: [statusId], references: [id])
  assigneeUser    User?               @relation("TaskAssignee", fields: [assigneeUserId], references: [id])
  createdByUser   User                @relation("TaskCreatedBy", fields: [createdByUserId], references: [id])
  updatedByUser   User?               @relation("TaskUpdatedBy", fields: [updatedByUserId], references: [id])
  checklistItems  TaskChecklistItem[]
  attachments     TaskAttachment[]

  @@unique([workspaceId, taskNumber])
  @@index([workspaceId, brandId])
  @@index([projectId])
  @@index([statusId])
  @@index([assigneeUserId])
  @@index([deletedAt])
  @@map("tasks")
}

model TaskChecklistItem {
  id       String  @id @default(cuid())
  taskId   String
  title    String
  isCompleted Boolean @default(false)
  sortOrder   Int     @default(0)

  createdByUserId   String
  completedAt       DateTime?
  completedByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task            Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdByUser   User  @relation("ChecklistItemCreatedBy", fields: [createdByUserId], references: [id])
  completedByUser User? @relation("ChecklistItemCompletedBy", fields: [completedByUserId], references: [id])

  @@index([taskId])
  @@map("task_checklist_items")
}

model TaskAttachment {
  id      String  @id @default(cuid())
  taskId  String
  mediaId String
  title   String?

  createdByUserId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task          Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  media         Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  createdByUser User  @relation("TaskAttachmentCreatedBy", fields: [createdByUserId], references: [id])

  @@index([taskId])
  @@index([mediaId])
  @@map("task_attachments")
}

/// ============================================================================
/// COMMENT MODEL - Global polymorphic comment system
/// ============================================================================

model Comment {
  id          String  @id @default(cuid())
  workspaceId String
  brandId     String?

  /// Entity this comment is attached to (e.g., "TASK", "CONTENT", "CRM_CONTACT")
  entityType String
  /// ID of the entity this comment is attached to
  entityId   String

  authorUserId String
  body         String @db.Text

  /// Thread/reply support - parent comment ID
  parentId String?

  isEdited  Boolean   @default(false)
  editedAt  DateTime?
  deletedAt DateTime? // Soft delete

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workspace  Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand      Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  authorUser User      @relation("CommentAuthor", fields: [authorUserId], references: [id])
  parent     Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[] @relation("CommentReplies")

  @@index([workspaceId, brandId])
  @@index([entityType, entityId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("comments")
}

/// ============================================================================
/// EMAIL VERIFICATION MODEL
/// ============================================================================

model EmailVerificationCode {
  id           String   @id @default(cuid())
  userId       String
  code         String   // 6-digit numeric code (100000-999999)
  expiresAt    DateTime // Code expiration time (typically 10 minutes)
  usedAt       DateTime? // When the code was successfully used (null if unused)
  attemptCount Int      @default(0) // Number of failed verification attempts
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@map("email_verification_codes")
}
