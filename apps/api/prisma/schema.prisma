// Prisma Schema File
// This file defines the database schema using Prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                  String            @id @default(cuid())
  email               String            @unique
  username            String?           @unique
  name                String?
  emailVerified       DateTime?
  googleId            String?           @unique
  firstOnboardedAt    DateTime?
  completedOnboarding Boolean           @default(false)
  lastLoginAt         DateTime?
  locale              String            @default("en")
  timezone            String            @default("UTC")
  dateFormat          String            @default("DD/MM/YYYY") // Date display format preference
  timeFormat          String            @default("24h") // Time display format: "12h" or "24h"
  phone               String?
  status              String            @default("active")
  avatarMediaId       String?           @unique
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  workspaceMembers    WorkspaceMember[]
  sessions            Session[]
  avatarMedia         Media?            @relation(fields: [avatarMediaId], references: [id])
  activityEvents      ActivityEvent[]
  assignedTasks       Task[]            @relation("UserAssignedTasks")
  reportedTasks       Task[]            @relation("UserReportedTasks")
  taskAttachments     TaskAttachment[]  @relation("UserTaskAttachments")

  @@map("users")
}

model Workspace {
  id             String               @id @default(cuid())
  name           String
  slug           String               @unique
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  members        WorkspaceMember[]
  roles          Role[]
  brands         Brand[]
  subscription   Subscription?        @relation("WorkspaceSubscription")
  invites        WorkspaceInvite[]
  media          Media[]
  socialAccounts SocialAccount[]
  brandContents  BrandContent[]
  hashtagPresets BrandHashtagPreset[]
  contents       Content[]
  publications   Publication[]
  activityEvents ActivityEvent[]
  taskCategories TaskCategory[]
  taskStatuses   TaskStatus[]
  tasks          Task[]

  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(MEMBER)
  invitedBy   String?
  invitedAt   DateTime?
  joinedAt    DateTime?
  status      String        @default("active")
  createdAt   DateTime      @default(now())
  user        User          @relation(fields: [userId], references: [id])
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
  @@map("workspace_members")
}

model Role {
  id              String           @id @default(cuid())
  workspaceId     String? // null ise global role, doluysa workspace-specific role
  key             String // örn: "workspace-owner", "content-manager"
  name            String
  description     String?
  builtIn         Boolean          @default(false)
  order           Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  workspace       Workspace?       @relation(fields: [workspaceId], references: [id])
  rolePermissions RolePermission[]

  @@unique([workspaceId, key]) // aynı workspace içinde aynı key iki kez olmasın, global roller için workspaceId null
  @@map("roles")
}

model Permission {
  id              String           @id @default(cuid())
  key             String           @unique // örn: "workspace:settings.view"
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model Session {
  id               String    @id // refresh token payload'daki `tid` ile birebir
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt        DateTime
  userAgent        String?
  ipAddress        String?
  lastActiveAt     DateTime  @default(now())
  refreshTokenHash String?
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())

  @@index([userId, expiresAt])
  @@map("sessions")
}

model Brand {
  id          String  @id @default(cuid())
  workspaceId String
  name        String
  slug        String
  description String?
  industry    String?
  language    String? // "tr", "en" etc.
  timezone    String? // IANA timezone
  toneOfVoice String? // friendly, corporate, etc.

  // Brand status and onboarding
  status              BrandStatus @default(DRAFT)
  onboardingStep      Int         @default(0)
  onboardingCompleted Boolean     @default(false)
  lastActivityAt      DateTime    @default(now())

  // Wizard / readiness
  profileCompleted             Boolean @default(false)
  hasAtLeastOneSocialAccount   Boolean @default(false)
  publishingDefaultsConfigured Boolean @default(false)
  readinessScore               Int     @default(0) // 0-100

  // Brand-level settings
  primaryColor   String? // "#RRGGBB"
  secondaryColor String?
  websiteUrl     String?
  logoMediaId    String?

  isArchived Boolean  @default(false)
  isActive   Boolean  @default(true)
  createdBy  String?
  updatedBy  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  workspace      Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  media          Media[]
  socialAccounts SocialAccount[]
  brandContents  BrandContent[]
  hashtagPresets BrandHashtagPreset[]
  studioContents Content[]
  publications   Publication[]
  taskCategories TaskCategory[]
  taskStatuses   TaskStatus[]
  tasks          Task[]

  @@unique([workspaceId, slug])
  @@index([workspaceId, createdAt])
  @@index([workspaceId, status])
  @@map("brands")
}

model Subscription {
  id          String             @id @default(cuid())
  workspaceId String             @unique
  plan        SubscriptionPlan   @default(FREE)
  status      SubscriptionStatus @default(ACTIVE)
  periodStart DateTime?
  periodEnd   DateTime?
  cancelAt    DateTime?

  workspace Workspace @relation("WorkspaceSubscription", fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkspaceInvite {
  id          String       @id @default(cuid())
  email       String
  workspaceId String
  invitedBy   String
  token       String       @unique
  status      InviteStatus @default(PENDING)
  expiresAt   DateTime

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum PublicationPlatform {
  instagram
  facebook
  linkedin
  tiktok
  twitter
}

enum SocialPlatform {
  FACEBOOK_PAGE
  INSTAGRAM_BUSINESS
  INSTAGRAM_BASIC
  YOUTUBE_CHANNEL
  TIKTOK_BUSINESS
  PINTEREST_PROFILE
  X_ACCOUNT
  LINKEDIN_PAGE
}

enum SocialAccountStatus {
  ACTIVE
  DISCONNECTED
  REMOVED
}

enum PublicationContentType {
  feed_post
  reel
  story
  carousel
  image
  video
  link
}

enum PublicationStatus {
  draft
  scheduled
  publishing
  published
  failed
  cancelled
}

enum BrandStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// Task Status Groups (Fixed, System-Level)
enum TaskStatusGroup {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskSource {
  MANUAL
  AUTOMATION
}

model Media {
  id           String   @id @default(cuid())
  workspaceId  String
  brandId      String?
  objectKey    String   @unique
  originalName String
  contentType  String
  sizeBytes    Int
  isPublic     Boolean  @default(false)
  variants     Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  Workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  Brand           Brand?           @relation(fields: [brandId], references: [id], onDelete: Cascade)
  userAvatar      User?
  taskAttachments TaskAttachment[]

  @@map("media")
}

model SocialAccount {
  id            String              @id @default(cuid())
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  workspaceId   String
  brandId       String
  platform      SocialPlatform
  externalId    String // pageId / channelId / profileId / etc.
  username      String?
  displayName   String?
  profileUrl    String?
  status        SocialAccountStatus @default(ACTIVE)
  lastSyncedAt  DateTime?
  avatarMediaId String? // future: mirror avatar into our Media service

  /// Encrypted JSON blob with all provider credentials.
  /// This is a STRING, not Json, because it is ENCRYPTED.
  credentialsEncrypted String

  /// Provider-specific non-secret meta data (safe to expose internally / to UI).
  /// Example: pageName, igBusinessAccountId, avatarUrl, etc.
  platformData Json?

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand        Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  publications Publication[]

  @@unique([workspaceId, platform, externalId])
  @@index([workspaceId, brandId])
  @@index([platform, externalId])
  @@map("social_accounts")
}

model BrandContent {
  id          String    @id @default(cuid())
  workspaceId String
  brandId     String
  title       String
  body        String?
  status      String    @default("draft")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  scheduledAt DateTime?

  brand     Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, brandId, createdAt])
  @@map("brand_contents")
}

model BrandHashtagPreset {
  id          String   @id @default(cuid())
  workspaceId String
  brandId     String
  name        String
  tags        Json // JSONB: string[] of hashtags
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand     Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([workspaceId, brandId])
  @@map("brand_hashtag_presets")
}

model Content {
  id          String   @id @default(cuid())
  workspaceId String
  brandId     String
  title       String
  baseCaption String? // platform-agnostic caption
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand        Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  publications Publication[]

  @@index([workspaceId, brandId])
  @@map("contents")
}

model Publication {
  id                   String                 @id @default(cuid())
  workspaceId          String
  brandId              String
  contentId            String? // Optional - null for direct social publishing
  socialAccountId      String? // Which social account to publish to
  platform             PublicationPlatform
  contentType          PublicationContentType
  scheduledAt          DateTime?
  publishedAt          DateTime?
  failedAt             DateTime?
  status               PublicationStatus
  caption              String? // Unified caption/message field
  permalink            String? // Platform's URL for the published post
  settings             Json // JSONB: platform/type-specific payload (legacy)
  payloadJson          Json? // JSONB: our structured payload for publishing
  error                Json? // JSONB: error details (legacy)
  providerResponseJson Json? // JSONB: full provider response
  externalPostId       String? // Provider's post ID (ig media id, fb post id)
  jobId                String? // BullMQ job ID
  clientRequestId      String? // Client-provided idempotency key
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand         Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  content       Content?       @relation(fields: [contentId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount? @relation(fields: [socialAccountId], references: [id], onDelete: SetNull)

  @@index([workspaceId, brandId])
  @@index([contentId])
  @@index([socialAccountId])
  @@index([status, scheduledAt])
  @@index([status, scheduledAt, platform])
  @@map("publications")
}

model ActivityEvent {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  workspaceId String?
  userId      String?
  actorType   String // 'user' | 'system' | 'integration'
  source      String // 'api' | 'worker' | 'webhook' | 'automation'
  type        String // event type, e.g. 'workspace.member_invited'
  scopeType   String? // 'workspace' | 'brand' | 'content' | 'publication' | 'user' | 'billing' | ...
  scopeId     String? // related entity id
  requestId   String? // X-Request-Id
  metadata    Json? // event-specific details

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  user      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([type])
  @@index([scopeType, scopeId])
  @@map("activity_events")
}

model TaskCategory {
  id          String   @id @default(cuid())
  workspaceId String
  brandId     String? // Brand-specific category or global (null)
  name        String
  slug        String
  color       String? // UI color (e.g. "#F97316")
  isDefault   Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand     Brand?    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@unique([workspaceId, brandId, slug])
  @@index([workspaceId, brandId])
  @@map("task_categories")
}

// User-Defined Task Statuses (grouped by TaskStatusGroup)
model TaskStatus {
  id          String          @id @default(cuid())
  workspaceId String
  brandId     String? // Brand-specific status or global (null)
  name        String // Display name (e.g. "In Review", "QA Testing")
  slug        String // Identifier (e.g. "in-review", "qa-testing")
  group       TaskStatusGroup // Which main group this belongs to
  color       String? // UI color (e.g. "#F97316")
  icon        String? // Icon identifier (e.g. "circle", "alert-circle")
  description String? // Optional description
  isDefault   Boolean         @default(false) // Is this a default/system status
  order       Int             @default(0) // Display order within group
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand     Brand?    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@unique([workspaceId, brandId, slug])
  @@index([workspaceId, brandId])
  @@index([group])
  @@map("task_statuses")
}

model Task {
  id          String            @id @default(cuid())
  workspaceId String
  brandId     String?
  title       String
  description String?
  categoryId  String?
  statusId    String            // FK to TaskStatus (user-defined status)
  priority    TaskPriority      @default(MEDIUM)
  assigneeId  String?
  reporterId  String
  dueDate     DateTime?
  startDate   DateTime?
  completedAt DateTime?
  source      TaskSource        @default(MANUAL)
  sourceMeta  Json?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  workspace   Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand       Brand?            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category    TaskCategory?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  status      TaskStatus        @relation(fields: [statusId], references: [id])
  assignee    User?             @relation("UserAssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporter    User              @relation("UserReportedTasks", fields: [reporterId], references: [id])
  attachments TaskAttachment[]

  @@index([workspaceId, brandId])
  @@index([categoryId])
  @@index([statusId])
  @@index([assigneeId])
  @@map("tasks")
}

// Task Attachments (files uploaded to tasks)
model TaskAttachment {
  id          String   @id @default(cuid())
  taskId      String
  mediaId     String
  uploadedBy  String
  createdAt   DateTime @default(now())

  task       Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  media      Media  @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  uploader   User   @relation("UserTaskAttachments", fields: [uploadedBy], references: [id])

  @@index([taskId])
  @@index([mediaId])
  @@map("task_attachments")
}
